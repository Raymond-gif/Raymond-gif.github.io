<script>
document.addEventListener("DOMContentLoaded", () => {
  // Select all headings with IDs
  const sections = document.querySelectorAll("h1[id], h2[id], h3[id]");

  // Select all TOC links in the right sidebar
  const navLinks = document.querySelectorAll(".sidebar__right .toc a");

  // Map heading IDs to their corresponding links
  const linkMap = {};
  navLinks.forEach(link => {
    const hash = link.getAttribute("href").split("#").pop();
    if (hash) linkMap[hash] = link;
  });

  const sidebar = document.querySelector(".sidebar__right");

  function onScroll() {
    let currentSection = "";

    // Find the last heading above scroll position
    sections.forEach(section => {
      const sectionTop = section.getBoundingClientRect().top + window.scrollY - 120;
      if (window.scrollY >= sectionTop) {
        currentSection = section.getAttribute("id");
      }
    });

    // Remove active class from all links
    Object.keys(linkMap).forEach(id => linkMap[id].classList.remove("active"));

    // Highlight current section
    if (currentSection && linkMap[currentSection]) {
      const activeLink = linkMap[currentSection];
      activeLink.classList.add("active");

      // Scroll sidebar to keep active link visible
      const sidebarTop = sidebar.scrollTop;
      const sidebarHeight = sidebar.clientHeight;
      const linkOffsetTop = activeLink.offsetTop;
      const linkHeight = activeLink.offsetHeight;

      if (linkOffsetTop < sidebarTop) {
        sidebar.scrollTop = linkOffsetTop - 10;
      } else if (linkOffsetTop + linkHeight > sidebarTop + sidebarHeight) {
        sidebar.scrollTop = linkOffsetTop - sidebarHeight + linkHeight + 10;
      }
    }
  }

  // Initial highlight
  onScroll();

  // Update highlight on scroll
  window.addEventListener("scroll", onScroll);
});
</script>
